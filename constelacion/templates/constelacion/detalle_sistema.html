{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}Detalle: {{ sistema.titulo }}{% endblock %}

{% block extra_head %}
    <style>
        /* Estilos b√°sicos para el contenedor del lienzo */
        #container-konva {
            width: 900px;
            height: 650px;
            border: 2px solid #555;
            background-color: #f8f8f8;
            margin: 20px auto;
            /* DEBES TENER esta imagen en static/constelacion/images/fondo_ambiente.png */
            /* Si no tienes la imagen, la l√≠nea de background-image debe ir comentada */
            /* background-image: url("{% static 'constelacion/images/fondo_ambiente.png' %}"); */
            background-size: cover;
        }
    </style>
{% endblock extra_head %}

{% block content %}
    <h1>Constelando: {{ sistema.titulo }} üé®</h1>
    
    <div style="text-align: center; margin-bottom: 15px;">
        <button onclick="addElement('persona')">üßç Persona</button>
        <button onclick="addElement('objeto')">üì¶ Objeto</button>
        <button onclick="addElement('concepto')">üí° Concepto</button>
        <button onclick="guardarConstelacion()">üíæ Guardar Posiciones</button>
        <p>Arrastra los elementos y luego guarda. Presiona CTRL + R para rotar.</p>
        <p><a href="{% url 'constelacion:dashboard_cliente' %}">Volver al Panel</a></p>
    </div>

    <div id="container-konva"></div>
    
    <form id="guardar-form" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="action" value="guardar">
        <input type="hidden" name="constelacion_data" id="constelacion-data">
    </form>

{% endblock content %}


{% block extra_js %}
    <script src="https://unpkg.com/konva@9.3.6/konva.min.js"></script>
    
    <script>
        // ----------------------------------------------------------------------
        // 1. INICIALIZACI√ìN DE KONVA Y VARIABLES GLOBALES
        // ----------------------------------------------------------------------
        const CONTAINER_ID = 'container-konva';
        const ANCHO = 900;
        const ALTO = 650;
        
        const stage = new Konva.Stage({
            container: CONTAINER_ID,
            width: ANCHO,
            height: ALTO,
        });
    
        // Usamos 'let' para que la capa pueda ser manipulada
        let layer = new Konva.Layer();
        stage.add(layer);
        
        // Array que contendr√° los objetos de datos que se env√≠an al backend
        let elementos = []; 

        // ----------------------------------------------------------------------
        // 2. L√ìGICA DE CARGA DE DATOS (EL PUNTO CR√çTICO)
        // ----------------------------------------------------------------------
        
        // üí° Paso 1: Obtener los datos JSON del backend y parsearlos.
        const datosIniciales = JSON.parse('{{ datos_json_iniciales|safe }}');
        
        if (datosIniciales && datosIniciales.length > 0) {
            console.log("Cargando sistema guardado con", datosIniciales.length, "elementos.");
            
            // üí° Paso 2: Asignamos los datos le√≠dos a la variable global 'elementos'
            elementos = datosIniciales; 
            
            // üí° Paso 3: Iteramos y llamamos a la funci√≥n de dibujo
            elementos.forEach(data => {
                // Aseg√∫rate de que todos los campos necesarios son pasados a renderElement
                renderElement(
                    data.name, 
                    data.type, 
                    data.x, 
                    data.y, 
                    data.rotation || 0, 
                    data.img_src || '', // Ya viene con el path /static/...
                    data.color || ''
                );
            });
        } else {
            console.log("Sistema Constelar vac√≠o. Comienza a crear!");
        }

        // ----------------------------------------------------------------------
        // 3. FUNCIONES AUXILIARES DE KONVA
        // ----------------------------------------------------------------------
        
        // Funci√≥n auxiliar para cargar im√°genes (A√±adimos manejo de error)
        function loadImage(src, callback) {
            const img = new Image();
            img.onload = function() {
                callback(img);
            };
            img.onerror = function() {
                console.error("‚ùå ERROR: No se pudo cargar la imagen:", src);
                // Si falla la imagen, pasamos null al callback para usar un fallback (ej: un c√≠rculo)
                callback(null); 
            };
            img.src = src; 
        }
        
        // 4. A√ëADIR ELEMENTO AVANZADO (Llamada desde el bot√≥n)
        function addElement(type) {
            const name = prompt(`Introduce el nombre para el nuevo ${type}:`);
            if (!name) return;
            
            let img_url = '';
            let color = '';
            
            // Usamos las URLs est√°ticas de Django
            switch (type) {
                case 'persona':
                    // Utilizamos la etiqueta 'static' para asegurar el path correcto
                    img_url = "{% static 'constelacion/images/mu√±eco_persona.png' %}"; 
                    color = 'blue'; 
                    break;
                case 'objeto':
                    img_url = "{% static 'constelacion/images/mu√±eco_objeto.png' %}";
                    color = 'green';
                    break;
                case 'concepto':
                    img_url = "{% static 'constelacion/images/mu√±eco_concepto.png' %}";
                    color = 'red';
                    break;
                default:
                    return;
            }
            
            // Posici√≥n inicial aleatoria
            const x = 50 + Math.random() * 200; 
            const y = 50 + Math.random() * 100;
            
            // Renderiza y a√±ade a la lista
            renderElement(name, type, x, y, 0, img_url, color);
        }

        // 5. RENDERIZAR (DIBUJAR) ELEMENTO CON KONVA
        function renderElement(name, type, x, y, rotation, img_url, color) {
            
            const group = new Konva.Group({
                x: x,
                y: y,
                draggable: true,
                rotation: rotation || 0,
                name: 'elemento-group', 
                id: name,
            });

            // 4a. A√±adir la figura (Imagen o Forma)
            if (img_url) {
                loadImage(img_url, function(img) {
                    let elementShape;
                    if (img) {
                        elementShape = new Konva.Image({
                            image: img,
                            width: 50, 
                            height: 50,
                            offsetX: 25,
                            offsetY: 25,
                        });
                    } else {
                        // Respaldo si la imagen falla
                        elementShape = new Konva.Circle({
                            radius: 25,
                            fill: color || 'gray',
                            stroke: 'black',
                            strokeWidth: 2,
                            offsetX: 0,
                            offsetY: 0,
                        });
                    }
                    group.add(elementShape);
                    layer.draw(); 
                });
            } else {
                // Si no hay URL de imagen (ej. Concepto sin imagen), usamos una forma simple
                const elementShape = new Konva.Circle({
                    radius: 25,
                    fill: color || 'red',
                    stroke: 'black',
                    strokeWidth: 2,
                    offsetX: 0,
                    offsetY: 0,
                });
                group.add(elementShape);
            }
            
            // 4b. A√±adir el texto del nombre
            const text = new Konva.Text({
                text: name,
                fontSize: 12,
                fontFamily: 'Arial',
                fill: '#000',
                offsetY: -35,
                align: 'center',
                width: 100, 
                offsetX: 50,
            });
            group.add(text);
            
            layer.add(group);
            layer.draw();

            // 5. Evento al dejar de arrastrar: Actualizar datos
            group.on('dragend', function() {
                updateElementPosition(this);
            });
            
            // Evento para guardar la rotaci√≥n
            group.on('transformend', function() {
                updateElementPosition(this);
            });
            
            // 6. Solo a√±adir a la lista si es un nuevo elemento
            if (!elementos.some(e => e.name === name)) {
                elementos.push({ name, type, x, y, rotation: 0, img_src: img_url, color: color });
            }
        }
        
        // 7. ACTUALIZAR POSICI√ìN Y ROTACI√ìN EN LOS DATOS
        function updateElementPosition(group) {
            const name = group.id();
            
            const index = elementos.findIndex(e => e.name === name);
            if (index !== -1) {
                elementos[index].x = group.x();
                elementos[index].y = group.y();
                elementos[index].rotation = group.rotation();
            }
        }

        // 8. FUNCI√ìN FINAL PARA GUARDAR (Env√≠a los datos a Django)
        function guardarConstelacion() {
            // üö® Aseg√∫rate de que los datos est√©n actualizados ANTES de guardar
            layer.find('.elemento-group').forEach(group => updateElementPosition(group));

            const jsonString = JSON.stringify(elementos);
            document.getElementById('constelacion-data').value = jsonString;
            document.getElementById('guardar-form').submit();
        }
        
        
        
    </script>
{% endblock extra_js %} 