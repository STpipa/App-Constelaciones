<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Constelar: {{ sistema.titulo }}</title>
    
    <style>
        #lienzo-constelacion {
            width: 800px;
            height: 600px;
            border: 2px solid #333;
            background-color: #f0f0f0;
            position: relative;
            margin: 20px auto;
        }
        .elemento {
            position: absolute;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            cursor: grab;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            font-size: 14px;
        }
        .persona { background-color: #ADD8E6; border: 1px solid blue; }
        .objeto { background-color: #90EE90; border: 1px solid green; }
        .concepto { background-color: #FFB6C1; border: 1px solid red; }
    </style>
</head>
<body>
    <h1>Constelando: {{ sistema.titulo }}</h1>
    <p>Intención: {{ sistema.descripcion }}</p>

    <button onclick="addElement('persona')">Añadir Persona</button>
    <button onclick="addElement('objeto')">Añadir Objeto</button>
    <button onclick="addElement('concepto')">Añadir Concepto</button>
    
    <div id="lienzo-constelacion">
        </div>
    
    <form id="guardar-form" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="guardar">
        <input type="hidden" name="constelacion_data" id="constelacion-data">
        <button type="button" onclick="guardarConstelacion()">Guardar Posiciones</button>
    </form>
    
    <script>
        const lienzo = document.getElementById('lienzo-constelacion');
        let elementos = []; // Almacenará los datos de la constelación (nombre, tipo, posición)
        let zIndexCounter = 1;

        // Cargar datos iniciales (si existen)
        const datosIniciales = JSON.parse('{{ datos_json_iniciales|safe }}');
        if (datosIniciales.length > 0) {
            elementos = datosIniciales;
            elementos.forEach(data => {
                renderElement(data.name, data.type, data.x, data.y);
            });
        }

        // 1. AÑADIR ELEMENTO
        function addElement(type) {
            const name = prompt(`Introduce el nombre para el nuevo ${type}:`);
            if (name) {
                // Posición inicial aleatoria
                const x = 50 + Math.random() * 200; 
                const y = 50 + Math.random() * 100;

                const data = { name, type, x, y };
                elementos.push(data);
                renderElement(name, type, x, y);
            }
        }

        // 2. RENDERIZAR (DIBUJAR) ELEMENTO
        function renderElement(name, type, x, y) {
            const div = document.createElement('div');
            div.className = `elemento ${type}`;
            div.textContent = name;
            div.style.left = `${x}px`;
            div.style.top = `${y}px`;
            div.dataset.name = name; // Guardar el nombre para identificación
            
            // Hacer que el elemento sea arrastrable
            makeDraggable(div);
            lienzo.appendChild(div);
        }

        // 3. HACER ARRASTRABLE (Draggable)
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            element.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                // Obtener la posición inicial del ratón
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.zIndex = zIndexCounter++; // Pone el elemento arrastrado arriba
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // Calcular la nueva posición del ratón
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // Establecer la nueva posición del elemento
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                // Dejar de arrastrar al soltar el botón
                document.onmouseup = null;
                document.onmousemove = null;
                // Actualizar la posición en el array 'elementos'
                updateElementPosition(element);
            }
        }
        
        // 4. ACTUALIZAR POSICIÓN EN LOS DATOS
        function updateElementPosition(element) {
            const name = element.dataset.name;
            const newX = element.offsetLeft;
            const newY = element.offsetTop;
            
            const index = elementos.findIndex(e => e.name === name);
            if (index !== -1) {
                elementos[index].x = newX;
                elementos[index].y = newY;
            }
        }

        // 5. FUNCIÓN FINAL PARA GUARDAR (Envía los datos a Django)
        function guardarConstelacion() {
            // Convierte el array de elementos a una cadena JSON
            const jsonString = JSON.stringify(elementos);
            
            // Coloca el JSON en el campo oculto del formulario
            document.getElementById('constelacion-data').value = jsonString;
            
            // Envía el formulario a la vista de Django
            document.getElementById('guardar-form').submit(); 
        }
    </script>
</body>
</html>