{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Constelar: {{ sistema.titulo }}</title>
    
    <script src="https://unpkg.com/konva@9.3.6/konva.min.js"></script>
    
    <style>
        /* Estilos b치sicos para el contenedor del lienzo */
        #container-konva {
            width: 900px;
            height: 650px;
            border: 2px solid #555;
            background-color: #f8f8f8;
            margin: 20px auto;
            /* Simula el "ambiente" */
            /* DEBES TENER esta imagen en static/constelacion/images/fondo_ambiente.png */
            /* Si no tienes la imagen, la l칤nea de background-image debe ir comentada */
            /* background-image: url("{% static 'constelacion/images/fondo_ambiente.png' %}"); */
            background-size: cover;
        }
    </style>
</head>
<body>
    <h1>Constelando: {{ sistema.titulo }} 游꿛</h1>
    
    <div style="text-align: center; margin-bottom: 15px;">
        <button onclick="addElement('persona')">游븴 Persona</button>
        <button onclick="addElement('objeto')">游닍 Objeto</button>
        <button onclick="addElement('concepto')">游눠 Concepto</button>
        <button onclick="guardarConstelacion()">游 Guardar Posiciones</button>
        <p>Arrastra los elementos y luego guarda. Presiona CTRL + R para rotar.</p>
        <p><a href="{% url 'constelacion:dashboard_cliente' %}">Volver al Panel</a></p>
    </div>

    <div id="container-konva"></div>
    
    <form id="guardar-form" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="guardar">
        <input type="hidden" name="constelacion_data" id="constelacion-data">
    </form>
    
    <script>
        const CONTAINER_ID = 'container-konva';
        const ANCHO = 900;
        const ALTO = 650;
        
        // 1. Inicializar la Etapa (Stage) y la Capa (Layer) de Konva
        const stage = new Konva.Stage({
            container: CONTAINER_ID,
            width: ANCHO,
            height: ALTO,
        });
        let layer = new Konva.Layer(); // 
        stage.add(layer);

        let elementos = []; // Estructura de datos para guardar la constelaci칩n

        // 丘멆잺 CRUCIAL: Obtener los datos JSON del backend
        // Este valor viene de la vista (views.py) y est치 listo para ser parseado
        const datosJsonIniciales = JSON.parse('{{ datos_json_iniciales|safe }}');

        // --------------------------------------------------------------------
        // L칍GICA DE CARGA INICIAL: Reconstruir la constelaci칩n si existen datos
        // --------------------------------------------------------------------
        if (datosJsonIniciales && datosJsonIniciales.children && datosJsonIniciales.children.length > 0) {
            // Usamos el m칠todo load() de Konva para restaurar la capa
            layer.destroy(); // Eliminamos la capa vac칤a inicial

            // 拘勇 CREAMOS Y REASIGNAMOS la capa con los datos.
            layer = Konva.Node.create(datosJsonIniciales); // Recreamos la capa desde el JSON
            
            stage.add(layer);
            layer.draw(); 
        
            // Tambi칠n debes reconstruir los objetos Konva.Text a partir de los datos
            // ... (Tu l칩gica para reconstruir los elementos a partir de datosJsonIniciales)
        
        } else {
            // Si no hay datos, inicializamos con la capa vac칤a (que ya hiciste)
            console.log("Sistema Constelar vac칤o. Comienza a crear!");
        }
        
        
        // Funci칩n auxiliar para cargar im치genes
        function loadImage(src, callback) {
            const img = new Image();
            img.onload = function() {
                callback(img);
            };
            img.onerror = function() {
                console.error("Error al cargar la imagen: " + src);
                // Si la imagen falla, podemos pasar un valor nulo para que use la forma de respaldo
                callback(null); 
            };
            // Usa la etiqueta 'static' de Django para la ruta. 
            // NOTA: Esta ruta DEBE ser relativa a la funci칩n est치tica de Django, 
            // pero la pasamos como string para que JavaScript la interprete.
            img.src = src; 
        }

        // 3. A칌ADIR ELEMENTO AVANZADO (Mu침eco)
        function addElement(type) {
            const name = prompt(`Introduce el nombre para el nuevo ${type}:`);
            if (!name) return;
            
            let img_url = '';
            let color = '';
            
            // Usamos las URLs est치ticas de Django, DEBES tener estos archivos en 
            // static/constelacion/images/
            switch (type) {
                case 'persona':
                    img_url = "{% static 'constelacion/images/mu침eco_persona.png' %}"; 
                    color = 'blue'; 
                    break;
                case 'objeto':
                    img_url = "{% static 'constelacion/images/mu침eco_objeto.png' %}";
                    color = 'green';
                    break;
                case 'concepto':
                    // Para concepto, generalmente no usamos imagen, usamos color
                    img_url = "{% static 'constelacion/images/mu침eco_concepto.png' %}";
                    color = 'red';
                    break;
                default:
                    return;
            }
            
            // Posici칩n inicial aleatoria
            const x = 50 + Math.random() * 200; 
            const y = 50 + Math.random() * 100;
            
            // Renderiza y a침ade a la lista
            renderElement(name, type, x, y, 0, img_url, color);
        }

        // 4. RENDERIZAR (DIBUJAR) ELEMENTO CON KONVA
        function renderElement(name, type, x, y, rotation, img_url, color) {
            const group = new Konva.Group({
                x: x,
                y: y,
                draggable: true,
                rotation: rotation || 0,
                name: 'elemento-group', 
                id: name,
            });

            // 4a. A침adir la figura (Imagen o Forma)
            if (img_url) {
                loadImage(img_url, function(img) {
                    let elementShape;
                    if (img) {
                        elementShape = new Konva.Image({
                            image: img,
                            width: 50, 
                            height: 50,
                            offsetX: 25,
                            offsetY: 25,
                        });
                    } else {
                        // Respaldo si la imagen falla
                        elementShape = new Konva.Circle({
                            radius: 25,
                            fill: color || 'gray',
                            stroke: 'black',
                            strokeWidth: 2,
                        });
                    }
                    group.add(elementShape);
                    layer.draw(); 
                });
            } else {
                // Si no hay URL de imagen (ej. Concepto), usamos una forma simple
                const elementShape = new Konva.Circle({
                    radius: 25,
                    fill: color || 'red',
                    stroke: 'black',
                    strokeWidth: 2,
                    offsetX: 0,
                    offsetY: 0,
                });
                group.add(elementShape);
            }
            
            // 4b. A침adir el texto del nombre
            const text = new Konva.Text({
                text: name,
                fontSize: 12,
                fontFamily: 'Arial',
                fill: '#000',
                offsetY: -35,
                align: 'center',
                width: 100, 
                offsetX: 50,
            });
            group.add(text);
            
            layer.add(group);
            layer.draw();

            // 5. Evento al dejar de arrastrar: Actualizar datos
            group.on('dragend', function() {
                updateElementPosition(this);
            });
            
            // Evento para guardar la rotaci칩n
            group.on('transformend', function() {
                updateElementPosition(this);
            });
            
            // Agregar a la estructura de datos si es nuevo
            if (!elementos.some(e => e.name === name)) {
                elementos.push({ name, type, x, y, rotation: 0, img_src: img_url });
            }
        }
        
        // 5. MANEJO DE LA INTERACCI칍N AVANZADA (Rotaci칩n)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault(); 
                
                // Rotar el 칰ltimo elemento en el array:
                if (elementos.length > 0) {
                    const lastElementData = elementos[elementos.length - 1];
                    const elementGroup = stage.findOne(`#${lastElementData.name}`);
                    
                    if (elementGroup) {
                        const newRotation = (elementGroup.rotation() + 45) % 360;
                        elementGroup.rotation(newRotation);
                        layer.draw();
                        updateElementPosition(elementGroup); // Guarda la rotaci칩n
                    }
                }
            }
        });

        function guardarSistema() {
            // 1. Serializar el estado de la capa principal (layer)
            // El m칠todo toJSON() de Konva convierte el estado completo de la capa 
            // y sus hijos (Elementos) en una cadena JSON.
            const constelacionData = layer.toJSON();

            // 2. Crear un formulario din치mico para enviar los datos por POST a Django
            const form = document.createElement('form');
            form.method = 'POST';
            // El action debe apuntar a la misma URL de la vista detalle_sistema
            form.action = ''; 

            // 3. Crear el campo CSRF Token (Obligatorio en Django)
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            // Obtenemos el valor del token que est치 en la plantilla
            csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
            form.appendChild(csrfToken);

            // 4. Crear el campo 'constelacion_data' (el JSON serializado)
            const dataInput = document.createElement('input');
            dataInput.type = 'hidden';
            dataInput.name = 'constelacion_data';
            dataInput.value = constelacionData; // El JSON del lienzo
            form.appendChild(dataInput);
    
            // 5. Crear un campo 'action' para que la vista sepa qu칠 hacer
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'guardar'; // Le decimos a Django que queremos guardar
            form.appendChild(actionInput);

            // 6. Enviar el formulario
            document.body.appendChild(form);
            form.submit();
        }

        // 6. ACTUALIZAR POSICI칍N Y ROTACI칍N EN LOS DATOS
        function updateElementPosition(group) {
            const name = group.id();
            
            const index = elementos.findIndex(e => e.name === name);
            if (index !== -1) {
                elementos[index].x = group.x();
                elementos[index].y = group.y();
                elementos[index].rotation = group.rotation();
            }
        }

        // 7. FUNCI칍N FINAL PARA GUARDAR (Env칤a los datos a Django)
        function guardarConstelacion() {
            // Aseg칰rate de que los datos est칠n actualizados antes de guardar
            layer.find('.elemento-group').forEach(group => updateElementPosition(group));

            const jsonString = JSON.stringify(elementos);
            document.getElementById('constelacion-data').value = jsonString;
            document.getElementById('guardar-form').submit();
        }

    </script>
</body>
</html>